name: IoT Firmware Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    if: "!contains(github.event.head_commit.message, 'chore(release):')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version
        id: vars
        run: |
          VERSION=$(git describe --tags --always --dirty)
          echo "FW_VERSION=${VERSION}" >> $GITHUB_ENV
          echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        
      - name: Extract Version Components
        id: version_components
        run: |
          # Устанавливаем значения по умолчанию для сборок не из тега
          MAJOR=0
          MINOR=0
          PATCH=0
          
          # Если сборка запущена тегом, парсим его
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION_TAG="${{ github.ref_name }}"
            VERSION_TAG=${VERSION_TAG#v} # Удаляем префикс 'v'
            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION_TAG"
            MAJOR=${VERSION_PARTS[0]:-0}
            MINOR=${VERSION_PARTS[1]:-0}
            PATCH=${VERSION_PARTS[2]:-0}
          fi
          
          echo "MAJOR=${MAJOR}" >> $GITHUB_ENV
          echo "MINOR=${MINOR}" >> $GITHUB_ENV
          echo "PATCH=${PATCH}" >> $GITHUB_ENV

      - name: Generate version.h
        run: |
          mkdir -p include
          cat <<EOF > include/version.h
          // Generated by GitHub Actions. DO NOT EDIT.
          #ifndef INCLUDE_VERSION_H_
          #define INCLUDE_VERSION_H_
          #include <string_view>
          namespace firmware::version {
          inline constexpr std::string_view kFirmwareVersion = "${{ env.FW_VERSION }}";
          inline constexpr std::string_view kGitSha = "${{ env.GIT_SHA }}";
          inline constexpr std::string_view kBuildTimestamp = "$(date -u +'%Y-%m-%dT%H:%M:%SZ')";
          inline constexpr int kMajor = ${{ env.MAJOR }};
          inline constexpr int kMinor = ${{ env.MINOR }};
          inline constexpr int kPatch = ${{ env.PATCH }};
          }
          #endif
          EOF

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Автоматически кэширует всё, что найдет в requirements.txt

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini', '**/requirements.txt') }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # 1. Установка из вашего файла требований
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
          # 2. Установка базовых инструментов, если их нет в requirements.txt
          pip install platformio cython setuptools wheel pyyaml littlefs-python

      - name: Install pyfatfs (Custom Build for M1/Ubuntu compatibility)
        run: |
          cd /tmp
          git clone https://github.com/Jason2866/pyfatfs
          cd pyfatfs
          # Генерируем C-код из Cython шаблонов
          python -m cython fatfs/wrapper.pyx
          # Устанавливаем в текущее окружение Python
          pip install .
          # Возвращаемся в рабочую директорию проекта
          cd ${{ github.workspace }}

      - name: Build Firmware
        run: pio run

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.FW_VERSION }}
          path: .pio/build/**/firmware.bin

      - name: Create Release Commit & Tag
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Гарантируем наличие всех тегов
          git fetch --tags
          
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a PARTS <<< "$VERSION"
          MAJOR=${PARTS[0]:-0}
          MINOR=${PARTS[1]:-0}
          PATCH=${PARTS[2]:-0}
          
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="v$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "Build successful. Creating release commit and tag: $NEW_TAG"
          
          # Создаем пустой коммит, чтобы привязать к нему тег и зафиксировать версию в истории
          git commit --allow-empty -m "chore(release): Release ${NEW_TAG}"
          git tag $NEW_TAG
          # Пушим коммит в main и все теги, которые на него ссылаются
          git push origin main --follow-tags

      - name: Prepare Release Asset
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Находим бинарник и копируем его с понятным именем (включая версию)
          find .pio/build -name firmware.bin -exec cp {} ./zigbee_water_meter_${{ env.FW_VERSION }}.bin \;

      - name: Publish Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: zigbee_water_meter_${{ env.FW_VERSION }}.bin
          generate_release_notes: true
          draft: false
          prerelease: false
          
      - name: Prepare Release Asset
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Находим бинарник и переименовываем его для релиза
          # Используем имя проекта, версию и архитектуру (например, esp32)
          mkdir -p release_assets
          cp .pio/build/*/firmware.bin release_assets/zigbee_water_meter_${{ github.ref_name }}.bin

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/*.bin
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## IoT Firmware Release ${{ github.ref_name }}
            
            **Metadata:**
            - Commit: `${{ env.GIT_SHA }}`
            - Build Date: `$(date -u +'%Y-%m-%d %H:%M:%SZ')`
            
            **Automated Build Artifacts:**
            Скачайте `.bin` файл ниже и прошейте ваше устройство.
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}